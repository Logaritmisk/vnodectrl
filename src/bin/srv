#!/bin/bash


. $VNODECTRL_LIB/common


if [ ! $# -eq 0 ]; then
	bootstrap $2
else
	${1:-@}
fi


mount | egrep "^$(echo $GUEST_ADDR | sed 's/\./\\\./g'):/srv on.*$" > /dev/null

if [ $? -eq 0 ]; then
    echo "Can't sync srv folder while mount is up."
    echo "Please unmount with 'vnodectrl umount' and try again."
    exit 1
fi


case $1 in
	host)
		echo         "This might delete files from host:/srv folder."
		read -n 1 -p "Do you still want to continue? (y/N): " choice && choice=${choice:-N}
		echo         ""
		
		if [ $choice = 'n' ] || [ $choice = 'N' ]; then
			exit 1
		fi
		
		rsync -azrPq --delete $GUEST_USER@$GUEST_ADDR:/srv/ $SRV_FOLDER
		
		exit 0
	;;
	guest)
		echo         "This might delete files from guest:/srv folder."
		read -n 1 -p "Do you still want to continue? (y/N): " choice && choice=${choice:-N}
		echo         ""
		
		if [ $choice = 'n' ] || [ $choice = 'N' ]; then
			exit 1
		fi
		
		rsync -azrPq --delete $SRV_FOLDER/ $GUEST_USER@$GUEST_ADDR:/srv
		
		exit 0
	;;
	unison)
		rsync -azrPq --delete $SRV_FOLDER/ $GUEST_USER@$GUEST_ADDR:/bak
		
		if [ ! $? -eq 0 ]; then
			exit 1
		fi
		
		ssh -q -oStrictHostKeyChecking=no $GUEST_USER@$GUEST_ADDR "unison -auto /bak /srv"
		
		if [ ! $? -eq 0 ]; then
			exit 1
		fi
		
		rsync -azrPq --delete $GUEST_USER@$GUEST_ADDR:/bak/ $SRV_FOLDER
		
		exit 0
	;;
	*)
		echo "Usage: `basename $0` {host|guest|unison}"
		
		exit 1
	;;
esac
